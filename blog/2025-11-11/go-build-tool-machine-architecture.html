<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="One of my favorite features of the Go programming language is that it can produce executables that I can copy to another machine and run without having to worry about dependencies on the target machine. To make things even better I can build executables for other operating systems, like Linux or Windows, from my Mac. For example, to build the executable for one of my projects (`marcli`) I run the following command on My Mac and I get a Mac executable: But I can also run the following command (again, from my Mac) and get instead a Linux executable:">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>Go executables and machine architecture</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>

    <!-- Styles from https://newcss.net/ -->
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.css">

    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <base href="https://hectorcorrea.com" />

    <!-- Lunr.js for searching, Mark.js for highlighting search results -->
    <script src="/public/lunr.min.js"></script>
    <script src="/public/mark.min.js"></script>

    <style>
      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      footer {
        background: var(--nc-bg-2);
        border-bottom: 1px solid var(--nc-bg-3);
        padding: 2rem 1.5rem;

        margin: -2rem calc(0px - (50vw - 50%)) 2rem;

        padding-left: calc(50vw - 50%);
        padding-right: calc(50vw - 50%);

        margin-top: -0px;
        margin-bottom: 0px;
        padding-top: 6px;
        padding-bottom: 6px;
        color: gray;
        font-size: x-small;
      }

      .header-link {
        /* Main body text, see new.css */
        color: var(--nc-tx-2);
        text-decoration: none;
      }

      .nav-link-selected {
        font-weight: bold;
      }

      .search-options {
        float: right;
      }

      .highlight-icon-on > a {
        background: var(--nc-ac-1);
      }

      .highlight-icon-off > a {
        background: var(--nc-bg-2);
      }

      .invisible {
        display: none;
      }

      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }

      @media only screen and (max-width: 600px) {
        .about-image {
          float: none;
        }
      }

      @media only screen and (min-width: 600px) {
        .about-image {
          float: right;
          margin-left: 25px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="/">Hector Correa</a></h1>
      <nav>
        <a id="about-menu" href="/about">About</a>
        | <a id="presentations-menu" href="/presentations">Presentations</a>
        | <a id="blog-menu" href="/blog">Blog</a>
        <span class="search-options">
          <span>
            <a href="/search" title="Search">
              <!--Magnifying glass source: https://icons.getbootstrap.com/icons/search/ -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
              </svg></a>
          </span>
          <span id="highlight-menu" class="invisible">
            <a href="#" title="Toggle highlight">
              <!-- Highlighter source: https://icons.getbootstrap.com/icons/highlighter/ -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-highlighter" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.096.644a2 2 0 0 1 2.791.036l1.433 1.433a2 2 0 0 1 .035 2.791l-.413.435-8.07 8.995a.5.5 0 0 1-.372.166h-3a.5.5 0 0 1-.234-.058l-.412.412A.5.5 0 0 1 2.5 15h-2a.5.5 0 0 1-.354-.854l1.412-1.412A.5.5 0 0 1 1.5 12.5v-3a.5.5 0 0 1 .166-.372l8.995-8.07zm-.115 1.47L2.727 9.52l3.753 3.753 7.406-8.254zm3.585 2.17.064-.068a1 1 0 0 0-.017-1.396L13.18 1.387a1 1 0 0 0-1.396-.018l-.068.065zM5.293 13.5 2.5 10.707v1.586L3.707 13.5z"/>
              </svg>
            </a>
          </span>
        </span>
      </nav>
    </header>

    <div id="page-content">
      <h1>Go executables and machine architecture</h1>

<p>One of my favorite features of the Go programming language is that it can produce executables that I can copy to another machine and run without having to worry about dependencies on the target machine. To make things even better I can build executables for other operating systems, like Linux or Windows, from my Mac.</p>

<p>For example, to build the executable for one of my projects (<code>marcli</code>) I run the following command on My Mac and I get a Mac executable:</p>

<pre>
go build -o marcli
</pre>

<p>But I can also run the following command (again, from my Mac) and get instead a Linux executable:</p>

<pre>
GOOS=linux go build -o marcli_linux
</pre>

<p>Notice the <code>GOOS</code> parameter is set to "linux" in the second example.</p>


<h2>The operating system</h2>
<p>The <code>GOOS</code> parameter in the previous command is what tells Go what kind of executable I want to build. There are many operating systems that the Go language supports out of the box including Mac OS (<code>GOOS=darwin</code>), Linux (<code>GOOS=linux</code>), and Windows (<code>GOOS=windows</code>)</p>

<p>You can get a list of all the supported operating systems by running <code>go tool dist list</code>, the results looks more or less like the one below (I listed only a few of the 48 options that the command shows):</p>

<pre>
darwin/amd64
darwin/arm64
linux/386
linux/amd64
linux/arm
linux/arm64
linux/mips
linux/riscv64
windows/386
windows/amd64
windows/arm64
</pre>

<p>The first part of each line shows the operating system (e.g. <code>darwin</code> or <code>linux</code>) and the second part is the architecture (more on this later).</p>

<p>The operating system is pretty obvious and most developers know what kind of operating system we are using, however the architecture is just as important for an executable and most of us are usually happily unaware of the architecture of the chip inside our machines (at least I am).</p>


<h2>The architecture of the machine</h2>

<p>The <a href="https://en.wikipedia.org/wiki/Computer_architecture">architecture of the machine</a> is determined by the chip inside of it and lucky for us we usually don't have to worry about it since the operating system knows how to deal with it. However, if we are going to build an executable for another computer we need to tell the Go compiler what kind of architecture we want for that executable.</p>

<p>For example, when I build an executable on my Mac with <code>go build -o marcli</code> internally the Go compiler is using two default values to determine the operating system (<code>GOOS</code>) and architecture (<code>GOARCH</code>) I want for the executable, <i>even if I don't specify one</i>.</p>

<p>For example in my Mac if run <code>go env GOOS GOARCH</code> I get the following values:</p>

<pre>
darwin
arm64
</pre>

<p>However, if run the same command on an older Mac I get the following values:</p>

<pre>
darwin
amd64
</pre>

<p>Notice that my new Mac uses the <a href="https://en.wikipedia.org/wiki/AArch64">ARM64</a> architecture whereas my old Mac uses the <a href="https://en.wikipedia.org/wiki/X86-64">AMD64</a> architecture (for some weird historical reasons sometimes the AMD64 architecure is refered as "x84-64".)</p>

<p>What this means is that if build an executable with just <code>go build -o marcli</code> I will get a different kind of executable depending on the Mac that I use. My newer Mac will by default produce a binary for the ARM64 architecture whereas my older Mac will default to the AMD64 architecture.</p>

<p>Luckly for us we can generate executables for different kind of architectures regardless of the architecture of our machine. For example I can run the following commands on my Mac:</p>

<pre>
GOOS=darwin GOARCH=amd64 go build -o marcli_amd64
GOOS=darwin GOARCH=arm64 go build -o marcli_arm64
</pre>

<p>and I will get two executables, both of them are for the Mac operating system (<code>GOOS=darwin</code>) but one of them is for Mac computers with the AMD64 architecture (<code>GOARCH=amd64</code>) whereas the other is for Mac computers with the ARM64 architecture (<code>GOARCH=arm64</code>).</p>

<p>I can inspect a given executable with the <code>file</code> command. For example file <code>marcli_amd64</code> will show "Mach-O 64-bit executable x86_64" whereas <code>file marcli_arm64</code> will show "Mach-O 64-bit executable arm64".</p>


<h2>What kind of architecure does my computer have?</h2>

<p>As I mentioned earlier the architecture of the machine is something that depends on chip inside of it and it's a pain to figure out.</p>

<p>On a Mac you can find what <i>chip</i> your computer has by clicking on the Apple icon (&#xF8FF;) on the upper left corner and selecting "About this Mac". The information displayed contains something like "Chip: Apple M4" or "Intel Core m3".</p>

<p>You can also find the chip information via the Terminal with a command like:</p>

<pre>
sysctl -a | grep brand
</pre>

<p>On my new Mac I get <code>machdep.cpu.brand_string: Apple M4</code> whereas on my old Mac I get <code>machdep.cpu.brand_string: Intel(R) Core(TM) m3-7Y32 CPU @ 1.10GHz</code>.</p>

<p>Once you know the chip a few searches on the web can help you figure out the <i>architecture</i> that corresponds for the chip in your machine. In my case Wikipedia says that the <a href="https://en.wikipedia.org/wiki/Apple_silicon">Apple M4</a> machines use the AMR64 architecure and the <a href="https://en.wikipedia.org/wiki/X86-64">Intel</a> machine use the AMD64 architecture. As I said earlier, kind of a pain to figure out.</p>


<h2>Building executable for other operating systems</h2>

<p>One thing that I recently <a href="https://github.com/hectorcorrea/marcli/issues/20">found out the hard way</a> was that <i>the architecture of my machine is used as the default architecture when I build an executable for another operating system</i>.</p>

<p>For example, if I am on an <b>older Mac</b> with the AMD64 architecture (<code>GOARCH=amd64</code>) and I build a Linux executable without specifing an architecture the Go compiler will attempt to use the same architecture for the Linux executable (notice the reference to the "x86-64" in the command below):</p>

<pre>
$ go env GOOS GOARCH
darwin
amd64

$ GOOS=linux go build -o marcli_linux
$ file marcli_linux
ELF 64-bit LSB executable, x86-64 ...
</pre>

<p>But if I am on a <b>newer Mac</b> with the ARM64 architecture (<code>GOARCH=arm64</code>) the exact same command will produce a different executable: it will produce an executable for Linux but for the ARM64 architecture (notice the "ARM aarch64" in the command below):</p>

<pre>
$ go env GOOS GOARCH
darwin
arm64

GOOS=linux go build -o marcli_linux
file marcli_linux
ELF 64-bit LSB executable, ARM aarch64
</pre>

<p>In hindsight this makes sense, without me indicating an architecture (<code>GOARCH</code>) the Go compiler takes a guess. The problem with this is that the fact that I have a Mac with the AMD64 architecture does not mean that the Linux machine where the executable will be used will also have this kind of architecture. But then again, there is no guarantee that the Linux machine will have an ARM64 architecture either.</p>

<p>The takeaway message is to always specify both the operating system (<code>GOOS</code>) and the architecture (<code>GOARCH</code>) of the executable that you are building. I think using <code>GOARCH=arm64</code> and <code>GOARCH=amd64</code> covers a lot of cases for Mac and Linux but then again this kind of knowledge is not my forte.</p>


<h2>Universal binaries on the Mac OS</h2>
<p>It is a bit of a pain to have to build executables taking into consideration the architecture of the target machine and I think it is even worse for users to have to chose what kind of executable they want to download. I mean how many of us know whether we want the ARM64 or AMD64 executable of a given tool.</p>

<p>On the Mac is possible to build <i>universal binaries</i> with the <code>lipo</code> tool that comes <a href="https://dev.to/thewraven/universal-macos-binaries-with-go-1-16-3mm3">built-in the Mac OS</a>.</p>

<p>For example we can build two different executables:</p>

<pre>
GOOS=darwin GOARCH=arm64 go build -o marcli_arm64
GOOS=darwin GOARCH=amd64 go build -o marcli_amd64
</pre>

<p>and then combine them to create an executable that will work regardless of whether you have an old Mac with the AMD64 architecture or a new Mac with the ARM64 architecture:</p>

<pre>
lipo -create -output marcli_universal marcli_amd64 marcli_arm64
</pre>

<p>If we inspect this executable with <code>file marcli_universal</code> we can see both architectures:</p>

<pre>
marcli_universal: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64]
marcli_universal (for architecture x86_64):	Mach-O 64-bit executable x86_64
marcli_universal (for architecture arm64):	Mach-O 64-bit executable arm64
</pre>

<p>A disadvantage of this approach is that the universal executable will be twice a large as each of the individual executables. Depending on your sitation this might be a problem or not, but I think it removes such a burden from the end user that it is worth considering.</p>

<p>Another disadvantage is that <code>lipo</code> is a tool for Mac OS, I am not sure if there are equivalents for other operating systems.</p>


    </div>

    <div id="search-section" class="invisible">
      <div id="search-params" class="">
        <input id="search-terms" size="50" />
        <button id="search-button">Go</button>
      </div>
      <div id="search-results">
      </div>
    </div>

    <footer>
      <a href="/tooling">Tooling</a> |
      License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
    </footer>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Hande this redirect via JavaScript because GitHub pages does not let me
      // handle this via an HTML redirect due to the ".aspx" extension
      if (window.location.pathname === "/blog/The-Mythical-Man-Month.aspx") {
        window.location = "https://hectorcorrea.com/blog/2007-06-28/the-mythical-man-month";
      }

      // Mark as selected the current menu option
      var selectMenu = function() {
        var activeOption = null;
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          activeOption = document.getElementById("blog-menu");
        } else if(url == "/about") {
          activeOption = document.getElementById("about-menu");
        } else if(url == "/presentations") {
          activeOption = document.getElementById("presentations-menu");
        }

        if (activeOption != null) {
          activeOption.classList.add("nav-link-selected");
        }
      }

      // Show the highlight menu if there is a hl query string parameter.
      // Notice that we don't automatically highlight search terms because that's annoying on the display
      // when there are too many hits.
      var showHighlightMenu = function() {
        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has("hl")) {
          var hlMenu = document.getElementById("highlight-menu");
          hlMenu.classList.remove("invisible");
        }
      }

      // Highlight search terms indicated in the URL via the
      // hl query string parameter
      var highlightSearchTerms = function() {
        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has("hl")) {
          var context = document.querySelector("#page-content");
          var instance = new Mark(context);
          instance.mark(urlParams.get("hl"));
          var hlMenu = document.getElementById("highlight-menu");
          hlMenu.classList.remove("invisible");
          hlMenu.classList.add("highlight-icon-on");
          hlMenu.classList.remove("highlight-icon-off");
        }
      }

      // Unhighlight the search terms
      var unhighlightSearchTerms = function() {
        var context = document.querySelector("#page-content");
        var instance = new Mark(context);
        instance.unmark();
        var hlMenu = document.getElementById("highlight-menu");
        hlMenu.classList.remove("highlight-icon-on");
        hlMenu.classList.add("highlight-icon-off");
      }

      // Wire the button to toggle the highlight
      document.getElementById("highlight-menu").addEventListener("click", (event) => {
        var hlMenu = document.getElementById("highlight-menu");
        if (hlMenu.classList.contains("highlight-icon-on")) {
          unhighlightSearchTerms();
        } else {
          highlightSearchTerms();
        }
        event.preventDefault();
      });

      // Open external links in a new tab
      var externalLinksNewTab = function() {
        var i;
        var links = document.getElementsByTagName("A");
        for(i = 0; i < links.length; i++) {
          var externalLink = !links[i].href.startsWith(window.location.origin);
          if (externalLink) {
            // Open on a new tab
            links[i].target = "_blank"
          }
        }
      }

      selectMenu();
      showHighlightMenu();
      externalLinksNewTab();
    </script>

    <script>
      if (window.location.pathname.startsWith("/search")) {
        // Only load the search index when we are on the search page
        // since it's kind of heavy, ~200KB.
        // Source https://stackoverflow.com/a/52478867/446681
        //
        // IMPORTANT: The call to document.write() will insert the
        // dynamic <script src=/searchIndex.js> block immediately
        // after this <script> block and therefore the code to
        // reference it MUST be on a separate <script> block.
        console.log("Loaded search index");
        document.write('<script src="/searchIndex.js"><\/script>');
      }
    </script>

    <script>
      // This <script> block has access to the searchDocuments
      // variable defined in searchIndex.js (see above)
      if (window.location.pathname.startsWith("/search")) {
        // Define the Lunr index
        var lunrIndex = lunr(function () {
          this.ref('id')
          this.field('name')
          this.field('text')

          searchDocuments.forEach(function (doc) {
            if (doc.id == "/404") {
              // don't index the content of the "404 not found" page
            } else {
              this.add(doc)
            }
          }, this)
        });

        // Function to execute the search
        var runSearch = function() {
          // Clear the previous results
          const resultsEl = document.getElementById("search-results");
          resultsEl.innerHTML = "";

          // Run the search
          const searchTerms = document.getElementById("search-terms").value;
          const results = lunrIndex.search(searchTerms);

          if (results.length == 0) {
            var noResults = document.createElement("p");
            noResults.textContent = "No results found";
            resultsEl.appendChild(noResults);
            return;
          }

          // Process the results
          results.forEach(function(result) {
            // This does not work because of word stemming (e.g. ruby => rubi)
            // var matchTerms = Object.keys(result.matchData.metadata).join(" ");
            var matchDoc = searchDocuments.find(x => x.id === result.ref)
            var linkEl = document.createElement("a");
            linkEl.href = matchDoc.id + "?hl=" + searchTerms;
            linkEl.text = matchDoc["name"];

            var resultEl = document.createElement("p");
            resultEl.appendChild(linkEl);

            resultsEl.appendChild(resultEl);
          });
        }

        // Make the search section visible
        document.getElementById("search-section").classList.remove("invisible");

        // Wire the click even in the search button
        document.getElementById("search-button").addEventListener("click", (event) => {
          runSearch();
        });

        // Wire the enter key on the search textbox
        // Source https://stackoverflow.com/a/46063448/446681
        document.getElementById("search-terms").addEventListener("keyup", (event) => {
          if (event.key === "Enter") {
            runSearch();
          }
        });

        // Give the focus to the search box
        document.getElementById("search-terms").focus();
      }
    </script>
  </body>
</html>
