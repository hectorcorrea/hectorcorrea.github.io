<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Below are the brief notes that I took while at DevConnections in Las Vegas (November/2008) This blog entry is mostly bullet points of things that I found interesting without much details. I'll elaborate on some of these topics in future blog entries. Scott Gu started with an overview of some of the new features released in the last year which included: Then he went to describe some of the new things coming in Visual Studio 2010 and ASP.NET 4.0 which included:">
    <meta name="author" content="hector@hectorcorrea.com">

    <title>DevConnections 2008</title>

    <link rel="shortcut icon" href="/public/favicon.ico" />
    <link rel="apple-touch-icon" href="/public/favicon.png"/>

    <!-- Styles from https://newcss.net/ -->
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.2/new.css">

    <link rel="me" href="https://mastodon.social/@hectorjcorrea" />
    <base href="https://hectorcorrea.com" />

    <!-- Lunr.js for searching, Mark.js for highlighting search results -->
    <script src="/public/lunr.min.js"></script>
    <script src="/public/mark.min.js"></script>

    <style>
      img {
        padding: 5px;
        box-shadow: 3px 3px 8px #222;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      footer {
        background: var(--nc-bg-2);
        border-bottom: 1px solid var(--nc-bg-3);
        padding: 2rem 1.5rem;

        margin: -2rem calc(0px - (50vw - 50%)) 2rem;

        padding-left: calc(50vw - 50%);
        padding-right: calc(50vw - 50%);

        margin-top: -0px;
        margin-bottom: 0px;
        padding-top: 6px;
        padding-bottom: 6px;
        color: gray;
        font-size: x-small;
      }

      .header-link {
        /* Main body text, see new.css */
        color: var(--nc-tx-2);
        text-decoration: none;
      }

      .nav-link-selected {
        font-weight: bold;
      }

      .search-options {
        float: right;
      }

      .highlight-icon-on > a {
        background: var(--nc-ac-1);
      }

      .highlight-icon-off > a {
        background: var(--nc-bg-2);
      }

      .invisible {
        display: none;
      }

      .socialLogo {
        padding: 0px;
        box-shadow: none;
        margin-right: 0px;
        margin-bottom: 0px;
        width: 16px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="/">Hector Correa</a></h1>
      <nav>
        <a id="about-menu" href="/about">About</a>
        | <a id="presentations-menu" href="/presentations">Presentations</a>
        | <a id="blog-menu" href="/blog">Blog</a>
        <span class="search-options">
          <span>
            <a href="/search" title="Search">
              <!--Magnifying glass source: https://icons.getbootstrap.com/icons/search/ -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
              </svg></a>
          </span>
          <span id="highlight-menu" class="invisible">
            <a href="#" title="Toggle highlight">
              <!-- Highlighter source: https://icons.getbootstrap.com/icons/highlighter/ -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-highlighter" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.096.644a2 2 0 0 1 2.791.036l1.433 1.433a2 2 0 0 1 .035 2.791l-.413.435-8.07 8.995a.5.5 0 0 1-.372.166h-3a.5.5 0 0 1-.234-.058l-.412.412A.5.5 0 0 1 2.5 15h-2a.5.5 0 0 1-.354-.854l1.412-1.412A.5.5 0 0 1 1.5 12.5v-3a.5.5 0 0 1 .166-.372l8.995-8.07zm-.115 1.47L2.727 9.52l3.753 3.753 7.406-8.254zm3.585 2.17.064-.068a1 1 0 0 0-.017-1.396L13.18 1.387a1 1 0 0 0-1.396-.018l-.068.065zM5.293 13.5 2.5 10.707v1.586L3.707 13.5z"/>
              </svg>
            </a>
          </span>
        </span>
      </nav>
    </header>

    <div id="page-content">
      <h1>DevConnections 2008</h1>
<p>Below are the brief notes that I took while at DevConnections in Las Vegas (November/2008) This blog entry is mostly bullet points of things that I found interesting without much details. I'll elaborate on some of these topics in future blog entries.</p>

<h2>Tuesday, November 11th</h2>


<h3>Opening Keynote</h3>

<p>Scott Gu started with an overview of some of the new features released in the last year which included:</p>

<ul>
<li>Dynamic data access (to build a database application with a wizard
<li>Charting controls for ASP.NET
<li>ASP.NET MVC - TDD friendly, closer to the metal (HTML) programming model, Not for everyone
<li>Several Silverlight demos
</ul>

<p>Then he went to describe some of the new things coming in Visual Studio 2010 and ASP.NET 4.0 which included:</p>

<ul>
<li>Visual Studio's UI will use WPF rather than Windows Form
<li>Better support for release and deployment (e.g. support for multiple web.config files, one for each environment)
<li>Better support for documentation and integration with TFS work items
<li>Native support for SharePoint
<li>TDD workflow
<li>Distributed caching for ASP.NET apps (look for project Velocity)
<li>NET continuum (web, desktop, RIA)
</ul>

<p>Chris Hammond has a very nice summary of this session.</p>

<h3>Entity Framework in a World of Services and Processes</h3>

<p>The Entity Data Model (.edmx) generated with the Entity Framework (EF) is serializable by default which makes it compatible with WCF out of the box.</p>

<p>Context in EF is the equivalent to a database connection in data access</p>

<p>Gotcha: You need to enumerate LINQ results before passing them back with the EF if you (as you should) surround your context with a using statement</p>

<pre class="code">
using (EF context)
{
  var blog = from x in ctx.Blogs select y;
  return blogs.ToArray() // enumerate before end of using
}
</pre>

<p>In my opinion, the Entity Framework seems unfinished. Although EF makes really easy to ready data using an object model the interface to save data (inserts and updates) looks complicated. Several "hacks" were needed to save data. The problem seems to stem from the fact that the EF is very good understanding state but not inferring intent. Currently all operations apply to the entire object graph and there is no easy way to make operations more granular. This will be worked out in version 2.</p>

<p>ADO.NET Data Sets (formerly known as Astoria) makes data accessible through HTTP via a REST approach. In this approach the intent is inferred from the URL.</p>

<p>SOAP uses lots of verbs while REST few verbs (put/get/post/delete) but lots of nouns.</p>


<h3>ASP.NET MVC - so what?</h3>

<p>Scott Hanselman gave a very good presentation describing what MVC provides and does not when compared with traditional ASP.NET Web Forms.</p>

<p>The first thing he clarified is that ASP.NET is greater than MVC or WebForms. Secondly, both approaches are here to stay. They target different audiences.</p>

<p>ASP.NET with Web Forms hides HTML from the developer and adds a state subsystem to HTML.</p>

<p>MVC is a new project type in ASP.NET. It gives the developer more control over the HTML, lends to code easier to test (TDD friendly), but it is not for everyone. Unlike WebForms there are no event in MVC, that is there is no button’s click event, no page postback, no viewstate, and no page lifecycle.</p>

<p>If we lose so many “web form” features with MVC, isn’t it like going back to classic ASP? No, there was no separation of concerns in classic ASP (more on this below) the code was all lumped in a single page and it wasn’t easy to test.</p>

<p>You can mix and match WebForms and MVC in a single web site.</p>

<p>A typical URL in an MVC follows this format: http://controller/method/methodparameter, for example: http://products/retrieve/3</p>

<p>The name MVC comes from the Model View Controller pattern. Sites with MVC use a controller (C) to interact with a model (M) to get data and return views (V). This model enforces a clear separation of concerns between the model, the view, and the controller, for example, the controller does not know anything about HTML, that’s the job of the view. The view does not know anything about the database, that’s the job of the model.</p>

<p>The default view used by MVC uses WebForms. You can build your own or use third party views. Scott showed a kind of view using a third party product called NHAML that was quite different to a traditional WebForm way of constructing an HTML page.</p>


<h3>LINQ to everything</h3>

<p>The speakers gave a tour of all the different LINQ flavors to query a variety of data sources. Slides can be found at http://blogs.msdn.com/aconrad/</p>

<ul>
<li>LINQ to objects - Provides a mechanism to query objects.
<li>LINQ to SQL – Provides LINQ’s functionality but targeting a database (SQL Server only) rather than objects.
<li>LINQ to Entities – A higher level of abstraction than LINQ to SQL, includes support for modeling (Entity Data Models) and supports multiple backend via plug-ins (although the only available at this point is for SQL Server)
<li>LINQ to DataSet – So that you don’t los you investment on DataSets Microsoft provides this flavor. The tag line is: "Not having to say you're sorry" Supports everything from DataSets (e.g. offline access) with a few extra features (e.g. LINQ joins)
<li>LINQ to XML – Provides a lightweight XML API (lighter than the DOM.) Several new XML classes are LINQ aware. For example, the new XDocument is LINQ aware but not the old XmlDocument.
</ul>

<p>Easier to generate XML documents with Linq to XML than traditional use of the DOM.</p>

<pre class="code">
XDocument xdoc = new XDocument(
new XElement("contacts", 
from c in contacts where country = "South Africa")
select new XElement("name")
</pre>

<p>VB.NET you can type XML directly as regular VB code (without having to add quotes) and embed expressions in the XML (similar to the way they are embedded in an ASP.NET) that get rendered at runtime to produce the final XML. This is really cool. Too bad we don’t have it in C#.</p>

<ul>
<li>LINQ to ADO.NET Data Services - ADO.NET Data Services allow you to publish your data model as REST-based web services so that any HTTP client can consume them. For example you can use a URL like this http:/localhost/myservice.svc/customers("ALFKI")/Orders to retrieve orders for customer with key “ALFKI”. You can query ADO.NET Data Services with LINQ.
<li>LINQ to Cloud Data Sources - At PDC earlier this year Microsoft unveiled two "cloud data sources": Microsoft Azure and SQL Data Services
<li>LINQ to (insert your custom provider here) – You can write your own data source and make it LINQ friendly. Must implement IQueryable&lt;T&gt; and IQueryProvider. The two main challenges are (1) translate LINQ expressions to your native data source language and (2) transform query results to objects. They demo a LINQ to Twitter implementation.
</ul>


<h3>Implementing RESTful Services with WCF 3.5 SP1</h3>

<p>www.RobBagby.com</p>

<p>In 1993 Web = Content, today Web = Content + Capabilities. Web is a graph of linked resources. Resources support a fixed set of operations (HTTP verbs)</p>

<p>REST is an architectural style, not a specification</p>

<p>Play well with HTTP (honor response codes, use verbs) as we build other applications to run on the web. HTTP has proven to be good why not continuing using it.</p>

<p>New 3.5 binding webHttpBinding does not use SOAP envelope, it's RESTful friendly.</p>

<p>Use WebGet and WebInvoke attributes.</p>

<p>WCF REST Starter Kit (CodePlex project) has three components: New DLL Microsoft.ServiceModel.Web.dll,  Visual Studio 2008 Templates and REST Samples.</p>

<p>Rob suggested four features our services should provide: (1) Use appropriated HTTP verbs, (2) Chose a representation, (3) Provide addressability, and (4) use valid HTTP response codes. These features are fully supported in the WCF REST Starter Kit via (1) WebGet attribute, (2) ResponseFormat parameter, (3) URITemplate, and (4) WebProtocolException class.</p>


<h2>Wednesday, November 12th</h2>


<h3>From one server to two: Making the leap</h3>

<p>I came late to this session so I don’t have much on the first part of it but I found it very interesting. The speaker (Richard Campbell) was very honest on what you get and what you don’t get when you start using more than one server to host your application.</p>

<p>You use load balancing to improve reliability and scalability, but that does not necessarily translate into performance. By using load balancing the application will be more resistant to hardware faults (reliability) and support more users (scalability) but it won’t become faster.</p>

<p>NLB adds overhead to the processing of a request, especially if you use server affinity.</p>

<p>You tell the cluster to drain a server, this will let the server finish processing whatever requests/sessions are currently on the server but it won’t take more requests. This work as expected when no affinity is used. When affinity is used draining a server can take hours since sessions don’t expire immediately and users could keep submitting requests on the same session and the machine won’t be free up until all sessions have been closed or expired.</p>

<p>If you use the no affinity approach objects need to be marked as serializable to be saved in the session cache. This is because with no affinity session is stored out of proc. It’s very important to keep session information to a minimal when storing it out of process.</p>

<p>Windows comes with a State Server that stores session (state) information in memory. It’s about twice as fast as storing information in SQL Server but it is a single point of failure. You can store session information in SQL Server as well and cluster SQL Server to prevent single point of failure. Third parties are worth considering.</p>

<p>He recommends that if you create a cluster, go all the way: use the no affinity approach.</p>

<p>When testing clusters make sure you test large time spans (10-15 minutes at least) to make sure you get a realistic picture.</p>

<p>Windows NLB detects if a machine goes down but it does not detect if IIS becomes non-responsive. You get what you paid for it.</p>


<h3>WCF Durable Services</h3>

<p>Juval Lowy started this session by talking about Custom Context in WCF and you can use this to pass out of band parameters in the header of a request. For example, if you need to have a way to identify who is making the call instead of passing an extra parameter on each method call you can store this information in the Context of the request and pass it back and forth.</p>

<p>There are three bindings that support this feature, look for bindings with the word “Context” on them, for example BasicHttpContextBinding.</p>

<p>He’s build a few wrapper classes that make using the context information a breeze. Download them from his site: http://idesign.com</p>

<p>After explaining this Juval moved to talk about durable sessions. He started by describing how in most client/server programming there is the implicit assumption that requests are short (milliseconds to minutes) Most client/server programming models assume this and work OK when the duration of the requests are short but fall short when requests take hours or days. On large time spans clients may come and go; hosts may come and go or move to different machines.</p>

<p>For long running requests you cannot keep service state in memory at all times, you need to persist it. Clients need to provide a state identifier so that the server can pull the correct state from the persistent storage. There are two basic was ways to pass this information around. One is to add an extra parameter to every call and pass the session identifier there but this is ugly and introduces “infrastructure” information to the business methods. A better approach is to pass this information in the context of the request.</p>

<p>You can add values to the context of a request from both, the client and the server. Server is the preferred approach.</p>

<p>If you change values on a static context on the server side make sure you make it thread safe (i.e. use lock)</p>

<p>To use durable services add DurableService attribute to your service class.</p>

<p>You can mark some of your methods with DurableOperation(CompleteInstance=true) to indicate that this method completes a session (e.g. the work to be done has been completed) and let the server know that when this method is called it can clear the session information for this caller. Once you end a session you need to recreate it (custom code required.)</p>

<p>Juval showed all his examples using a “File Persistent” provider to keep things simple. WCF provides a SQL Persistent provider. Look under the 3.5\SQL folder for the scripts to create the database.</p>

<p>Towards the end Juval closed the session by demoing “transactional memory” – this was very cool but I got lost in the process and my notes are not very clear. The basic idea was that you can implement transactions for operations that happen in memory. For example, execute this process but don’t change any values in memory if an exception happens in the process. Basically you decide when changes to values in memory are committed.</p>


<h3>Building a WCF Router for Your Applications</h3>

<p>This Michelle Leroux Bustamante talked how to create a WCF Service to route messages. There are two kinds of routers: Pass-Through routers and Processing Routers. This was by far the most advanced session that attended in the conference. Even though Michelle did a great job explaining the topic it was waaaaay more than I could understand.</p>

<p>She described several reasons why you might want to build your own router. A routing service can serve as a software load balancer (which is typically not very practical since routers are cheap these days) but it can also do routing based on the content of the message (requests from strict SLA clients go to the best servers) something that a hardware solution couldn’t provide. A router service is also useful if you want to support online/offline scenarios.</p>

<p>There are several considerations that you need to be aware when building a service router. When a router receives a message and forwards it to a different service it can change its header, content, both, or none. If a router A does not change the header information and forwards it to service A that does not use security the request will be accepted by service A. However if the Service A implements security at it will reject the message because in the header indicates that the message was originally for router A (not Service A.) If the router is smart enough it can change the header of the message to indicate that the receiving end is really Service A but this introduces another issue because now Service A will see that somebody has tampered with the original headers. Michelle explained ways to address these issues using supported WCF functionality. She even showed how to support different transport protocols between the client and the router (e.g. HTTP) and the router and the service (TCP.) None of this was trivial for the uneducated like me but nevertheless possible and well supported in WCF.</p>

<p>In general it seems that routing is very easy until you turn on security. It’s very easy to thing that it only took a couple of minutes to get it working until you realize that security is off. Once you turn security on then you’ll deal into the things that she described.</p>

<p>There were several interesting demos showing how messages would go back and forth to different servers depending on different algorithms including round robin, information on the message header or the message body.</p>


<h3>LINQ to SQL</h3>

<p>Dino Esposito presented a very good introduction to LINQ to SQL. LINQ to SQL provides an object model on which LINQ operates to read and write data to a database. It also provides an abstraction layer on top of connections, data readers, datasets, transactions, and such.</p>

<p>LINQ to SQL is SQL Server specific. Other vendors might support it in the future.</p>

<p>Classes generated in the object model used by LINQ to SQL have C# attributes that describe what table/column they represent in the database. These classes are partial and you can extend them, for example to add business logic.</p>

<p>Relationships between tables are implemented as composite classes in the object model provided by LINQ to SQL. For example, Customer.Invoices[0].DueDate and Invoice.Customer.FirstName</p>

<p>The entry point to the object model is the DataContext class. This is the class that tracks changes. This class is short-lived and it’s recreated on each ASP.NET request. Opening a DataContext does not necessarily open a database connection, the database will not be hit until the first read or write to the data is detected. The fact that this class is recreated on each request is an issue in n-tier applications. This is the issue mentioned on the “Entity Framework in a World of Services and Processes” session yesterday and that will not be addressed until V2.0 of the Entity Framework.</p>

<p>Something that I found curious is that for queries you use LINQ syntax (which looks a lot like SQL syntax) but for updated you need to create a new object, populate the values that you want to change, and then call some specific methods (like SubmitChanges) to push the data to the database. Like in the session about the Entity Framework yesterday it seems that they’ve done a great job when it comes to reading data but the procedure to perform updates seems kludgy. That whole concept that you clone an object and then attached to a different DataContext just does not look right. I am sure you can get used to it but it just makes the product seem unfinished.</p>

<p>Dino was extremely honest on some of the awkward things when working with LINQ to SQL (most of which also apply to EF.) For example if you turn of lazy loading (aka deferred instantiation) some of the children collections like Customer.Orders.Count will return zero. He also showed some of the hacks that he had to go through when trying to force an update when a property that didn’t match one to one to a field was used.</p>

<p>In general LINQ to SQL and the Entity Framework look like great ideas that one should keep an eye on. If I didn’t knew about the CSLA Framework that Rockford Lhotka provides for free I would be all over this stuff, but since Lhotka’s framework has been around for a while is a more mature product. You can use LINQ (and LINQ to SQL and I suppose even the Entity Framework) with CSLA but CSLA provides enough that I don’t see much value on LINQ to SQL and EF in their current state.</p>


<h2>Thursday, November 13th</h2>


<h3>High Performance Computing (HPC)</h3>

<p>Nick Landry presented this session. High Performance Computing is used in scenarios when a user needs to submit a massive job, where as load balancing is used to handle massive number of users. An HPC Cluster is similar to a super computer, more than a typical network cluster.</p>

<p>An example where HPC is used is to calculate stock projections. Calculating the stock projection for a single stock is a very intensive job and it gets even worse when we need to calculate projections for the entire portfolio of a large client. In this case a massive job (calculate stock projections for these 100 stocks) is submitted to HPC cluster in which multiple machines work on the same job.</p>

<p>Microsoft provides a product called Windows HPC Server 2008 (formerly known as “Compute Cluster Server) that runs on top of Windows 2008 to create a HPC Cluster. http://microsoft.com/hpc</p>

<p>Version 1 of Windows HCP accepted batch jobs only submitted via a command line. In Version 2 there is an API that allows you to submit jobs.</p>

<p>To get started you need Windows Server 2008 plus the HPC Pack. The HPC Pack is licensed by CPU and Microsoft’s offer is the cheapest of the products around. The HPC Pack is what you use to setup the “head node” or to join an existing cluster. The head node runs the scheduler and knows about other machines.</p>

<p>There are .NET libraries to submit jobs to a HPC Cluster. For example, a single GetProjectionsForAllMyStocks() call will be broken down into multiple tasks (for example one per available computer) and run in parallel.</p>


<h3>Productive WCF</h3>

<p>In this session Juval Lowy focused on how to use WCF more than the plumbing underneath. He started by talking about WcfSvcHost.exe to host WCF Services without having to write your own host wrapper code. You can use it to start a WCF library project. You can call it with a /client parameter to fire both server and client applications at the same time. You can also call WcfTestClient.exe program to call a particular server (similar to the ASP.NET Web Service test page)</p>

<p>Instrumentation. WCF has several performance counters that you can use to monitor WCF Services. Just turn on performance counters in your config file (under ServiceModel) and monitor them with perfmon like you would typically would.</p>

<p>Tracing and logging. “It’s an illusion that clients care about the details of an exception” – most clients application have “if returnValue == OK then do X else display message to the user” In reality there is very little that the client application can do with the error other than telling the user “sorry” – if there was something to do the app would have already done it. Don’t create custom exception. Use the already build in ones.</p>

<p>You can turn on tracing and logging via the configuration file or with the WCF Configuration tool (look under diagnosis.) Make sure you turn on “auto-flush” so that the logging information is saved even if you stop the debugger in the middle of a session.</p>

<p>The “activity ID” checkbox in the WCF Configuration tool refers to a “logical thread” that tracks the activity across all tiers (client, host, service, et cetera.) The TraceViewer utility can automatically merge the log file from the client and the server with this activity ID. This is really cool.</p>

<p>Operations Overloading. You  can modify the proxy class to support multiple method overloading by tagging them different via an attribute. For example to alias Add(int, int) into AddInt and Add(float, float) into AddFloat.</p>

<p>DataSets and DataTables. You should not return DataSets in your services. They are not good for other platforms other than .NET and are bound to database schema. You should use arrays instead</p>

<p>Fault Debugging. By default exception information is not bubbled up to the client application. He showed some code on the server side where he throws exception using throw new FaultException(ExceptionDetail) where ExceptionDetail is a custom class. You need to turn on “include exception detail” at the service level for this to work.</p>

<p>Once you turn use this code you can catch FaultException&lt;ExceptionDetail&gt; in addition to a generic catch FaultException in your client application.</p>


<h3>Using jQuery with ASP.NET</h3>

<p>Rick Strahl gave a very good overview of what is jQuery, what it can do, and how to use it.</p>

<p>jQuery is conceptually like “LINQ to HTML” in the sense that it allows you to query the HTML document at runtime and returns collections of objects. Rick called it the new HTML API.</p>

<p>jQuery is open source and quite popular, there are 100s of plug-ins available for it. The download is pretty small: 16KB. It uses CSS 3 selector syntax (dot to select classes, pound sign to select IDs)</p>

    </div>

    <div id="search-section" class="invisible">
      <div id="search-params" class="">
        <input id="search-terms" size="50" />
        <button id="search-button">Go</button>
      </div>
      <div id="search-results">
      </div>
    </div>

    <footer>
      <a href="/tooling">Tooling</a> |
      License <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
    </footer>

    <script type="text/javascript">
      // Redirect legacy blog URLs
      if (window.location.hash.startsWith("#/blog")) {
        window.location = window.location.toString().replace("#/blog/","blog/");
      }

      // Hande this redirect via JavaScript because GitHub pages does not let me
      // handle this via an HTML redirect due to the ".aspx" extension
      if (window.location.pathname === "/blog/The-Mythical-Man-Month.aspx") {
        window.location = "https://hectorcorrea.com/blog/2007-06-28/the-mythical-man-month";
      }

      // Mark as selected the current menu option
      var selectMenu = function() {
        var activeOption = null;
        var url = window.location.pathname;
        if (url.startsWith("/blog/")) {
          activeOption = document.getElementById("blog-menu");
        } else if(url == "/about") {
          activeOption = document.getElementById("about-menu");
        } else if(url == "/presentations") {
          activeOption = document.getElementById("presentations-menu");
        }

        if (activeOption != null) {
          activeOption.classList.add("nav-link-selected");
        }
      }

      // Show the highlight menu if there is a hl query string parameter.
      // Notice that we don't automatically highlight search terms because that's annoying on the display
      // when there are too many hits.
      var showHighlightMenu = function() {
        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has("hl")) {
          var hlMenu = document.getElementById("highlight-menu");
          hlMenu.classList.remove("invisible");
        }
      }

      // Highlight search terms indicated in the URL via the
      // hl query string parameter
      var highlightSearchTerms = function() {
        const queryString = window.location.search
        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has("hl")) {
          var context = document.querySelector("#page-content");
          var instance = new Mark(context);
          instance.mark(urlParams.get("hl"));
          var hlMenu = document.getElementById("highlight-menu");
          hlMenu.classList.remove("invisible");
          hlMenu.classList.add("highlight-icon-on");
          hlMenu.classList.remove("highlight-icon-off");
        }
      }

      // Unhighlight the search terms
      var unhighlightSearchTerms = function() {
        var context = document.querySelector("#page-content");
        var instance = new Mark(context);
        instance.unmark();
        var hlMenu = document.getElementById("highlight-menu");
        hlMenu.classList.remove("highlight-icon-on");
        hlMenu.classList.add("highlight-icon-off");
      }

      // Wire the button to toggle the highlight
      document.getElementById("highlight-menu").addEventListener("click", (event) => {
        var hlMenu = document.getElementById("highlight-menu");
        if (hlMenu.classList.contains("highlight-icon-on")) {
          unhighlightSearchTerms();
        } else {
          highlightSearchTerms();
        }
      });

      // Open external links in a new tab
      var externalLinksNewTab = function() {
        var i;
        var links = document.getElementsByTagName("A");
        for(i = 0; i < links.length; i++) {
          var externalLink = !links[i].href.startsWith(window.location.origin);
          if (externalLink) {
            // Open on a new tab
            links[i].target = "_blank"
          }
        }
      }

      selectMenu();
      showHighlightMenu();
      externalLinksNewTab();
    </script>

    <script>
      if (window.location.pathname.startsWith("/search")) {
        // Only load the search index when we are on the search page
        // since it's kind of heavy, ~200KB.
        // Source https://stackoverflow.com/a/52478867/446681
        //
        // IMPORTANT: The call to document.write() will insert the
        // dynamic <script src=/searchIndex.js> block immediately
        // after this <script> block and therefore the code to
        // reference it MUST be on a separate <script> block.
        console.log("Loaded search index");
        document.write('<script src="/searchIndex.js"><\/script>');
      }
    </script>

    <script>
      // This <script> block has access to the searchDocuments
      // variable defined in searchIndex.js (see above)
      if (window.location.pathname.startsWith("/search")) {
        // Define the Lunr index
        var lunrIndex = lunr(function () {
          this.ref('id')
          this.field('name')
          this.field('text')

          searchDocuments.forEach(function (doc) {
            if (doc.id == "/404") {
              // don't index the content of the "404 not found" page
            } else {
              this.add(doc)
            }
          }, this)
        });

        // Function to execute the search
        var runSearch = function() {
          // Clear the previous results
          const resultsEl = document.getElementById("search-results");
          resultsEl.innerHTML = "";

          // Run the search
          const searchTerms = document.getElementById("search-terms").value;
          const results = lunrIndex.search(searchTerms);

          if (results.length == 0) {
            var noResults = document.createElement("p");
            noResults.textContent = "No results found";
            resultsEl.appendChild(noResults);
            return;
          }

          // Process the results
          results.forEach(function(result) {
            // This does not work because of word stemming (e.g. ruby => rubi)
            // var matchTerms = Object.keys(result.matchData.metadata).join(" ");
            var matchDoc = searchDocuments.find(x => x.id === result.ref)
            var linkEl = document.createElement("a");
            linkEl.href = matchDoc.id + "?hl=" + searchTerms;
            linkEl.text = matchDoc["name"];

            var resultEl = document.createElement("p");
            resultEl.appendChild(linkEl);

            resultsEl.appendChild(resultEl);
          });
        }

        // Make the search section visible
        document.getElementById("search-section").classList.remove("invisible");

        // Wire the click even in the search button
        document.getElementById("search-button").addEventListener("click", (event) => {
          runSearch();
        });

        // Wire the enter key on the search textbox
        // Source https://stackoverflow.com/a/46063448/446681
        document.getElementById("search-terms").addEventListener("keyup", (event) => {
          if (event.key === "Enter") {
            runSearch();
          }
        });

        // Give the focus to the search box
        document.getElementById("search-terms").focus();
      }
    </script>
  </body>
</html>
